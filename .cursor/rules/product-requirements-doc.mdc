---
description: 
globs: 
alwaysApply: true
---
# Leadâ€‘Photo Autoâ€‘Tagger â€“ Updated PRD (Geminiâ€‘first, noâ€‘Docker)

## 1 Â· Purpose & Context

Field teams shoot thousands of leadâ€‘testing photos in Malawi and Kenya. Each object must be renamed to its handwritten sample code (MWI.â€¦ or KEN.â€¦). Manual renaming is slow and errorâ€‘prone. We will build a browserâ€‘based app (runs locally, no Docker required) that:

- Autoâ€‘extracts the code with Gemini Flash Vision.
- Extracts the topâ€‘5 colour palette clientâ€‘side.
- Renames all matching images and groups those missing a visible label using time/visual similarity.
- Lets a human correct unknowns or mistakes in a Linearâ€‘style grid at lightning speed.

## 2 Â· Success Metrics

| Metric | Target |
|--------|--------|
| Autoâ€‘tag accuracy | â‰¥ 80 % straightâ€‘through |
| Human review speed | â‰¤ 1 sec/fix |
| Throughâ€‘put | 2 000 photos â†’ export in < 10 min on M1 Air |
| Cloud spend (Gemini) | â‰¤ $0.20 for 2 000 imgs |

## 3 Â· Personas

**Tammy (Field Researcher)** â€“ drags a camera folder into the browser and exports a zipped, renamed set.

**QA Reviewer** â€“ bulkâ€‘fixes unknown rows with spreadsheetâ€‘like shortcuts.

## 4 Â· Scope (v1)

### MUST Have

- **Dragâ€‘nâ€‘drop upload** of files/folders (JPEG, PNG, HEIC).
- **Immediate Table View** (chronologically sorted):
  - Columns: â˜, Preview, New Name, Original Name, Group, Status (3 icons: ðŸŽ¨ palette ok / ðŸ“ code ok / ðŸ”— grouped).
- **Parallel processing** â€“ Up to 100 images at a time.
  - Step A: extract colour palette (client JS + kâ€‘means).
  - Step B: call Gemini Flash Vision with prompt:
    ```
    Respond only with JSON (properly spaced and formatted, "NA" if blank)
    {
      "code": "MWIâ€¦ or KENâ€¦",
      "otherText": "â€¦",
      "objectDesc": "3 words or less"
    }
    ```
  - If code found â‡’ New Name = code or code_2â€¦; Group = code; ðŸ“ icon â†’ green.
- **Postâ€‘processing autoâ€‘group** for unlabeled
  - Window: Â±30 s.
  - Condition: â‰¥2 shared palette colours OR exact objectDesc.
- **Spreadsheetâ€‘like fixes** â€“ Arrow keys navigate; drag fillâ€‘handle copies Group/Name down.
- **Export button** â€“ creates /output folder (or zipped download) only after user hits Apply.

### NICE to Have

- Oneâ€‘click "Ask again with higherâ€‘quality Gemini 1.5 Pro" on a selection.
- Multiâ€‘user share link (Supabase rowâ€‘levelâ€‘secured bucket).

## 5 Â· Nonâ€‘Functional Requirements

- **Zero Docker** â€“ install with `npm i && npm start` (Node18). Uses tsâ€‘node for backend and Vite for frontend.
- **Localâ€‘first** â€“ photos are read via browser File System Access API; only a base64â€‘JPEG preview is POSTed to the local Node server, then to Gemini.
- **Performance** â€“ kâ€‘means < 50 ms/img; Gemini batch â‰¤ 1 req/sec budgeted.
- **Extensibility** â€“ detector interface: `detectLabel(imgBuf) â†’ {code, otherText, objectDesc}` enabling GPTâ€‘4o swap.

## 6 Â· Technical Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  HTTP  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  HTTPS  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ React (Vite) â”‚â—€â”€â”€â”€â”€â”€â”€â–¶â”‚  Local NodeJS â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Gemini API  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  (Express)    â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–²                 â”‚  â€¢ Palette    â”‚
      â”‚ Browser FS API  â”‚  â€¢ Similarity â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

No Celery; concurrency handled by pâ€‘limit inside Node. Temp data stored in SQLite (via Prisma) inside the project folder; thumbnails in /.cache.

## 7 Â· Detailed Functional Flow

1. **Upload** â†’ frontend lists files instantly (uses lastâ€‘modified for chrono order).
2. **Processing queue** (max 100 concurrent):
   - Palette via nodeâ€‘vibrant (topâ€‘5 RGB + %).
   - Send to Gemini Flash Vision; parse JSON.
   - Row update events streamed via SSE â†’ UI icons flip green/amber.
3. **Clustering pass** after all Gemini results:
   - For every unknown, find nearest photo within Â±30 s sharing â‰¥ 2 palette hexes OR same objectDesc.
   - If match â‡’ inherit Group/Name, ðŸ”— icon green.
4. **User edits** â€“ grid supports multiâ€‘select, dragâ€‘fill, hotkeys (G to set group, N to rename).
5. **Apply** â€“ Node renames/copies to /output; zip if size < 2 GB.

## 8 Â· UI Snapshot

- **Toolbar** â€“ Filter (All / Unknown / Conflict) Â· Search Â· Apply (disabled until edits) Â· Export.
- **Grid** â€“ Virtualised rows; first col checkbox; hover shows fullâ€‘image tooltip. Status cell shows three stacked icons: ðŸŽ¨ ðŸ“ ðŸ”— turning greyâ†’amberâ†’green.
- **Right sidebar** â€“ Large preview; metadata list:
  - New Name
  - Old Name  
  - Taken: 2025â€‘06â€‘23 14:52:04
  - Palette: â–‰â–‰â–‰â–‰â–‰
  - Code: MWI.1.3â€¦
  - OtherText: "SUNFLOWER OIL" â€¦

## 9 Â· Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Gemini rateâ€‘limits | delays | 100â€‘concurrency cap + exponential backâ€‘off |
| HEIC decoding on Windows | load failure | Use sharp library; fall back to libheifâ€‘wasm in browser |
| Palette false positives | bad grouping | Require BOTH palette & time unless user toggles "aggressive mode" |

## 12 Â· Acceptance

Run `npm start`, open `localhost:3000`, drop 2 000 mixed photos â†’ < 10 min â†’ zipped `/output` with â‰¤ 20 % amber icons. 

It's important that our code, file breakdowns, etc. are done in a way that is scaleable, seperation of concerns, and maintainable.